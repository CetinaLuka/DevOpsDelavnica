# JaCoCo SonarQube Configuration Guide

## Problem Fixed
**Issue**: JaCoCo warnings during SonarQube analysis:
```
Warning: Classes in bundle 'measurements' do not match with execution data.
Warning: Execution data for class si/um/feri/measurements/vao/Measurement does not match.
...
```

## Root Cause
The `BE-static-code-analysis` workflow job was rebuilding the entire backend from scratch, which created new compiled class files with different bytecode than the classes used during test execution in the `BE-build-test-package` job. JaCoCo requires an exact bytecode match between:
1. The execution data (`.exec` file generated during tests)
2. The compiled class files used for report generation

When these don't match, JaCoCo cannot correctly map coverage data to source code.

## Solution Implemented

### Workflow Changes
Modified `.github/workflows/workflow.yml` to:

1. **Download build artifacts** instead of rebuilding:
```yaml
- name: Download build artifacts
  uses: actions/download-artifact@v4
  with:
    name: Package
    path: backend/target/
```

2. **Generate JaCoCo report** from existing execution data:
```yaml
- name: Generate JaCoCo report
  run: mvn -B jacoco:report
  working-directory: backend/
```

3. **Run SonarQube analysis** without recompilation:
```yaml
- name: Run SonarQube analysis
  run: mvn -B org.sonarsource.scanner.maven:sonar-maven-plugin:sonar ...
```

4. **Removed unnecessary services**: PostgreSQL service was removed from the SonarQube job since we're no longer running tests there.

## JaCoCo Report Path Configuration

### Maven Configuration (pom.xml)
The JaCoCo report path is correctly configured in `backend/pom.xml`:

```xml
<properties>
  <sonar.coverage.jacoco.xmlReportPaths>${project.build.directory}/site/jacoco/jacoco.xml</sonar.coverage.jacoco.xmlReportPaths>
</properties>
```

### File Locations
- **Execution data**: `backend/target/jacoco.exec`
  - Created by JaCoCo agent during test execution
  - Binary format containing coverage data

- **XML Report**: `backend/target/site/jacoco/jacoco.xml`
  - Generated by `mvn jacoco:report`
  - XML format consumed by SonarQube

### JaCoCo Maven Plugin Configuration
The plugin is configured with two executions:

```xml
<plugin>
  <groupId>org.jacoco</groupId>
  <artifactId>jacoco-maven-plugin</artifactId>
  <version>0.8.11</version>
  <executions>
    <execution>
      <id>prepare-agent</id>
      <goals>
        <goal>prepare-agent</goal>
      </goals>
    </execution>
    <execution>
      <id>report</id>
      <phase>verify</phase>
      <goals>
        <goal>report</goal>
      </goals>
    </execution>
  </executions>
</plugin>
```

## What Path to Give SonarQube

### If using Maven Sonar Plugin (recommended - already configured):
No additional path needed! The configuration is already set via the Maven property:
```xml
<sonar.coverage.jacoco.xmlReportPaths>${project.build.directory}/site/jacoco/jacoco.xml</sonar.coverage.jacoco.xmlReportPaths>
```

### If using SonarScanner CLI:
Add to `sonar-project.properties`:
```properties
sonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml
```

### If using SonarQube Scanner GitHub Action:
Add to workflow:
```yaml
- name: SonarQube Scan
  uses: SonarSource/sonarqube-scan-action@v2
  with:
    args: >
      -Dsonar.coverage.jacoco.xmlReportPaths=backend/target/site/jacoco/jacoco.xml
```

## Verification

After these changes, the workflow will:
1. Build and test in `BE-build-test-package` job (generates `jacoco.exec`)
2. Upload the entire `target/` directory as an artifact
3. Download that artifact in `BE-static-code-analysis` job
4. Generate XML report from the execution data
5. Run SonarQube analysis with matching bytecode

This eliminates the "classes do not match" warnings and provides accurate coverage reporting.

## Summary

**Answer to "What path for jacoco report I should give sonar?"**

The path is already correctly configured in your `pom.xml`:
```
target/site/jacoco/jacoco.xml
```

You don't need to change this - the fix was in the workflow to ensure the execution data and class files match during analysis.
